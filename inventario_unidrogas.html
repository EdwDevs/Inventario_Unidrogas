<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario LABS CHALVER — Móvil</title>

  <!-- Fuentes e íconos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* -----------------------
       Variables y reset
       ----------------------- */
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --primary: #16406b;
      --primary-600: #0f2a4a;
      --accent: #1e90ff;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --muted: #6b7280;
      --border: #e6eef6;
      --radius: 12px;
      --shadow-sm: 0 4px 10px rgba(12, 38, 63, 0.06);
      --gap: 12px;
      --touch: 46px; /* tamaño mínimo táctil */
      --transition: 200ms cubic-bezier(.2,.9,.3,1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,var(--bg) 0%, #e9f0f8 100%);
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-size:15px;
      line-height:1.35;
      -webkit-tap-highlight-color:transparent;
    }

    /* -----------------------
       Layout principal (mobile-first)
       ----------------------- */
    .app{
      max-width:1100px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      padding-bottom:24px;
    }

    header.app-header{
      position:sticky;
      top:0;
      z-index:50;
      padding:14px 16px;
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:#fff;
      border-radius:0 0 18px 18px;
      box-shadow:var(--shadow-sm);
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand {
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
      min-width:0;
    }

    .brand .logo{
      background:rgba(255,255,255,0.12);
      width:44px;height:44px;border-radius:10px;
      display:grid;place-items:center;font-size:18px;
    }

    .brand h1{
      font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .brand p{font-size:12px;opacity:0.95;margin-top:2px;font-weight:500}

    .header-meta{
      text-align:right;
      font-size:12px;
      min-width:120px;
      line-height:1.1;
    }

    .header-meta .company{display:block;font-weight:600}
    .header-meta .datetime{opacity:0.95;font-weight:400;font-size:13px;margin-top:4px}

    /* -----------------------
       Stats cards (compact)
       ----------------------- */
    .stats {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      padding:12px 16px;
      align-items:stretch;
    }

    .stat {
      background:var(--card);
      border-radius:12px;
      padding:10px;
      box-shadow:var(--shadow-sm);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:84px;
      justify-content:center;
    }

    .stat .label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.06em}
    .stat .value{font-size:20px;font-weight:800;color:var(--primary)}

    .stat .icon {
      position:absolute;
      opacity:0.08;
      right:10px;
      top:8px;
      font-size:46px;
      transform:rotate(-12deg);
    }

    /* -----------------------
       Controls: search + filters
       ----------------------- */
    .controls{
      padding:12px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .search-wrap{
      flex:1; min-width:0; position:relative;
    }

    .search-input{
      width:100%;
      height:var(--touch);
      padding:10px 44px 10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      font-size:15px;
      outline:none;
      transition:var(--transition);
      box-shadow:none;
    }

    .search-input:focus{box-shadow:0 6px 16px rgba(30,144,255,0.12);border-color:var(--accent)}

    .search-icon{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:16px;
    }

    .filters{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .segmented{
      display:inline-flex;
      background:transparent;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:var(--shadow-sm);
    }

    .segmented button{
      min-width:44px;
      padding:8px 10px;
      border:0;
      background:transparent;
      font-weight:700;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      transition:var(--transition);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
    }

    .segmented button[aria-pressed="true"]{
      background:linear-gradient(90deg,var(--primary),var(--primary-600));
      color:white;
    }

    /* -----------------------
       View toggle
       ----------------------- */
    .view-toggle{
      display:flex;
      gap:8px;
      padding:8px 16px;
    }

    .view-toggle button{
      border:0;background:transparent;padding:8px 12px;border-radius:10px;font-weight:700;color:var(--muted);cursor:pointer;
    }

    .view-toggle button.active{
      background:var(--card);box-shadow:var(--shadow-sm);color:var(--primary)
    }

    /* -----------------------
       Result info & pagination
       ----------------------- */
    .results-bar{
      padding:8px 16px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      font-weight:600;color:var(--muted);
      font-size:13px;
    }

    .results-bar .left{display:flex;gap:8px;align-items:center}
    .results-bar .right{font-weight:700;color:var(--primary);font-size:13px}

    .pagination{
      display:flex;gap:8px;align-items:center;padding:10px 16px;
      justify-content:center;flex-wrap:wrap;
    }

    .page-btn{
      height:36px;min-width:36px;padding:0 8px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);display:grid;place-items:center;font-weight:700;cursor:pointer;
    }

    .page-btn[disabled]{opacity:0.45;cursor:default}

    .page-btn.active{
      background:linear-gradient(90deg,var(--primary),var(--primary-600));color:white;border-color:transparent;
    }

    /* -----------------------
       Table & Cards
       ----------------------- */
    .table-wrap{
      padding:0 12px 8px;
      overflow:auto;
    }

    table.products{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
      border-radius:12px;
      overflow:hidden;
      box-shadow:var(--shadow-sm);
      border:1px solid var(--border);
    }

    thead th{
      text-align:left;padding:12px;font-weight:700;font-size:13px;color:white;background:linear-gradient(90deg,var(--primary),var(--primary-600));
      position:relative;
    }

    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle;font-size:14px}

    .product-name{font-weight:700;color:var(--primary);display:block;line-height:1.2}
    .lab{font-size:12px;color:var(--muted);margin-top:4px;font-weight:600}

    .status-badge{
      padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:white;display:inline-block;
    }
    .badge-alto{background:var(--success)}
    .badge-medio{background:var(--warning)}
    .badge-poco{background:#e67e22}
    .badge-agotado{background:var(--danger)}

    /* Cards view (mobile friendly) */
    .cards{
      display:grid;
      gap:12px;
      padding:12px;
    }

    .card{
      background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow-sm);border:1px solid var(--border);
    }

    .card .header{display:flex;align-items:flex-start;gap:10px}
    .card .header .title{font-weight:800;color:var(--primary);font-size:15px}
    .card .meta{font-size:12px;color:var(--muted);margin-top:6px}

    .card .rows{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .meta-pill{border-radius:10px;padding:8px 10px;background:linear-gradient(180deg,#fff,#f6fbff);font-weight:700;font-size:13px;border:1px solid var(--border)}

    /* No results */
    .no-results{
      padding:28px 18px;text-align:center;color:var(--muted);
    }

    /* -----------------------
       Desktop / larger view
       ----------------------- */
    @media(min-width:720px){
      .stats{grid-template-columns:repeat(5,1fr)}
      .controls{padding:12px 20px}
      .search-input{height:48px}
      .cards{grid-template-columns:repeat(2,1fr)}
      .table-wrap{padding:0 20px 18px}
    }

    @media(min-width:1000px){
      .cards{grid-template-columns:repeat(3,1fr)}
      .brand h1{font-size:18px}
    }

    /* scrollbar aesthetics */
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--primary))}
    ::-webkit-scrollbar-track{background:transparent}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Header -->
    <header class="app-header" role="banner">
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true"><i class="fas fa-pills"></i></div>
        <div style="min-width:0">
          <h1 title="Inventario LABS CHALVER">INVENTARIO LABS CHALVER</h1>
          <p style="margin-top:4px;font-size:12px;opacity:0.95">Sistema de control de stock — LABS CHALVER DE COLOMBIA</p>
        </div>
      </div>

      <div class="header-meta" aria-hidden="false">
        <span class="company"><i class="fas fa-building"></i> LABS CHALVER</span>
        <span class="datetime" id="currentDateTime" aria-live="polite">—</span>
      </div>
    </header>

    <!-- Stats -->
    <section class="stats" aria-label="Resumen de inventario">
      <div class="stat" title="Total de productos">
        <div class="label">Total</div>
        <div class="value" id="statTotal">0</div>
        <i class="fas fa-boxes icon" aria-hidden="true"></i>
      </div>

      <div class="stat" title="Disponibles">
        <div class="label">Disponibles</div>
        <div class="value" id="statAvailable">0</div>
        <i class="fas fa-check-circle icon" aria-hidden="true"></i>
      </div>

      <div class="stat" title="Crítico">
        <div class="label">Crítico</div>
        <div class="value" id="statCritical">0</div>
        <i class="fas fa-exclamation-triangle icon" aria-hidden="true"></i>
      </div>

      <div class="stat" title="Agotados">
        <div class="label">Agotados</div>
        <div class="value" id="statOut">0</div>
        <i class="fas fa-times-circle icon" aria-hidden="true"></i>
      </div>

      <div class="stat" title="Valor total">
        <div class="label">Valor total</div>
        <div class="value" id="statValue">$0</div>
        <i class="fas fa-dollar-sign icon" aria-hidden="true"></i>
      </div>
    </section>

    <!-- Controls -->
    <section class="controls" role="region" aria-label="Controles de búsqueda y filtro">
      <div class="search-wrap" role="search">
        <input id="searchInput" class="search-input" type="search" inputmode="search" placeholder="Buscar producto, laboratorio..." aria-label="Buscar productos">
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>

      <div class="filters" role="toolbar" aria-label="Filtros de estado">
        <div class="segmented" role="tablist" aria-label="Filtrar por estado">
          <button class="filter-btn" data-filter="todos" aria-pressed="true" title="Todos"><i class="fas fa-list"></i></button>
          <button class="filter-btn" data-filter="alto" aria-pressed="false" title="Alto"><i class="fas fa-arrow-up"></i></button>
          <button class="filter-btn" data-filter="medio" aria-pressed="false" title="Medio"><i class="fas fa-equals"></i></button>
          <button class="filter-btn" data-filter="poco" aria-pressed="false" title="Crítico"><i class="fas fa-exclamation"></i></button>
          <button class="filter-btn" data-filter="agotado" aria-pressed="false" title="Agotado"><i class="fas fa-times"></i></button>
        </div>
      </div>
    </section>

    <!-- View toggle -->
    <div class="view-toggle" role="tablist" aria-label="Vista">
      <button class="view-btn" data-view="cards" aria-pressed="true" title="Ver como tarjetas"><i class="fas fa-th-large"></i> Tarjetas</button>
      <button class="view-btn" data-view="table" aria-pressed="false" title="Ver como tabla"><i class="fas fa-table"></i> Tabla</button>
    </div>

    <!-- Result info -->
    <div class="results-bar" aria-live="polite">
      <div class="left"><i class="fas fa-info-circle"></i> <span id="resultsText">Mostrando 0 productos</span></div>
      <div class="right" id="sortInfo">Orden: Producto (A-Z)</div>
    </div>

    <!-- Table wrapper -->
    <div class="table-wrap" id="tableWrap" style="display:none;">
      <table class="products" aria-label="Tabla de productos">
        <thead>
          <tr>
            <th data-sort="name" scope="col">Producto / Laboratorio <span class="sort-indicator" aria-hidden="true"></span></th>
            <th data-sort="price" scope="col">Precio <span class="sort-indicator" aria-hidden="true"></span></th>
            <th data-sort="stock" scope="col">Stock <span class="sort-indicator" aria-hidden="true"></span></th>
            <th data-sort="status" scope="col">Estado <span class="sort-indicator" aria-hidden="true"></span></th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </div>

    <!-- Cards -->
    <section class="cards" id="cardsContainer" aria-live="polite"></section>

    <!-- No results -->
    <div id="noResults" class="no-results" style="display:none;">
      <div style="font-size:28px;margin-bottom:8px;opacity:0.7"><i class="fas fa-search-minus"></i></div>
      <div style="font-size:16px;font-weight:700;margin-bottom:6px">No se encontraron productos</div>
      <div style="font-size:13px;color:var(--muted)">Prueba con otros términos de búsqueda o filtros.</div>
    </div>

    <!-- Pagination -->
    <nav class="pagination" id="pagination" aria-label="Paginación"></nav>

    <!-- Footer summary -->
    <footer style="padding:16px" aria-label="Resumen final">
      <div style="background:linear-gradient(180deg,#fff,#f6fbff);border-radius:12px;padding:12px;border:1px solid var(--border);box-shadow:var(--shadow-sm)">
        <strong>Resumen:</strong>
        <div style="margin-top:8px;font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:6px">
          <div id="footerMaxStock">Mayor Stock: —</div>
          <div id="footerHighestPrice">Precio más alto: —</div>
          <div id="footerAttention">Atención: — productos en estado crítico</div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    /* -------------- Datos (sin cambios funcionales) -------------- */
    const products = [
      { name: "INFLACOR RET 3/3MG AMP X 1ML (BETAMETASONA)", lab: "LABS CHALVER DE COLOMBIA", price: 37049, stock: 1233, category: "alto" },
      { name: "AIRMAX SALBUTAMOL 100 MCG INHALADOR X 200 DOSIS", lab: "LABS CHALVER DE COLOMBIA", price: 14601, stock: 381, category: "alto" },
      { name: "DESCONGEL GRIPA ACETAMINOFEN/LORATADINA/FENILEFRINA X 100 CAP", lab: "LABS CHALVER DE COLOMBIA", price: 117010, stock: 345, category: "alto" },
      { name: "CUTAMYCON CLOTRIMAZOL 1% CREMA X 20 GR", lab: "LABS CHALVER DE COLOMBIA", price: 15507, stock: 338, category: "alto" },
      { name: "TRIGENTAX CR X 40GR (CLOTRIMAZOL+NEOMICINA+BETAMETASONA)", lab: "LABS CHALVER DE COLOMBIA", price: 44106, stock: 210, category: "medio" },
      { name: "ZAKOR 100MG X 6 TBS (MEBENDAZOL)", lab: "LABS CHALVER DE COLOMBIA", price: 7275, stock: 198, category: "medio" },
      { name: "ASPROMIO IPRATROPIO 0.4 MG/ML INHALADOR X 200 DOSIS", lab: "LABS CHALVER DE COLOMBIA", price: 19105, stock: 188, category: "medio" },
      { name: "MULTIDOL EXPRESS 400MG X 48CBG (IBUPROFENO)", lab: "LABS CHALVER DE COLOMBIA", price: 42910, stock: 182, category: "medio" },
      { name: "TRIGENTAX LOC TOP. X 50ML (CLOTRIMAZOL+NEOMICINA+BETAMETASONA)", lab: "LABS CHALVER DE COLOMBIA", price: 53662, stock: 148, category: "medio" },
      { name: "CLOBEZAN CLOBETASOL 0.05% LOCION X 60 ML", lab: "LABS CHALVER DE COLOMBIA", price: 66443, stock: 119, category: "medio" },
      { name: "DESCONGEL GRIPA ACETAMINOFEN/LORATADINA/FENILEFRINA GOTAS X 15 ML", lab: "LABS CHALVER DE COLOMBIA", price: 18687, stock: 118, category: "medio" },
      { name: "DUOPAS IBUPROFENO/HIOSCINA 400/20 MG X 10 CAP", lab: "LABS CHALVER DE COLOMBIA", price: 45329, stock: 116, category: "medio" },
      { name: "ESTERMAX ESTROGENOS CONJUGADOS CREMA VAGINAL X 42.8 GR", lab: "LABS CHALVER DE COLOMBIA", price: 28133, stock: 103, category: "medio" },
      { name: "FLUZETRIN FACETAMINOFEN/CETIRIZINA/FENILEFRINA X 10 TAB", lab: "LABS CHALVER DE COLOMBIA", price: 31969, stock: 88, category: "poco" },
      { name: "FEMTRIOL ESTRIOL 0.1 GR CREMA VAGINAL X 20 GR X 5 APLICADORES", lab: "LABS CHALVER DE COLOMBIA", price: 25498, stock: 72, category: "poco" },
      { name: "INFLACOR RET 6/6MG AMP X 2ML (BETAMETASONA)", lab: "LABS CHALVER DE COLOMBIA", price: 55626, stock: 72, category: "poco" },
      { name: "NEUROPRON INY 2ML X 3AMP", lab: "LABS CHALVER DE COLOMBIA", price: 109386, stock: 71, category: "poco" },
      { name: "FLUZETRIN FACETAMINOFEN/CETIRIZINA/FENILEFRINA JARABE X 60 ML", lab: "LABS CHALVER DE COLOMBIA", price: 34832, stock: 51, category: "poco" },
      { name: "ESTROGENOS CONJUGADOS CREMA VAGINAL X 40 GR", lab: "LABS CHALVER DE COLOMBIA", price: 30547, stock: 32, category: "poco" },
      { name: "TRIGENTAX CR X 20GR (CLOTRIMAZOL+NEOMICINA+BETAMETASONA)", lab: "LABS CHALVER DE COLOMBIA", price: 25539, stock: 32, category: "poco" },
      { name: "FRIOTAN HEDERA HELIX 65 MG X 10 CAP", lab: "LABS CHALVER DE COLOMBIA", price: 34474, stock: 21, category: "poco" },
      { name: "VAGINSOL F 100+200MG X 3 OVULOS (CLINDAMICINA+CLOTRIMAZOL)", lab: "LABS CHALVER DE COLOMBIA", price: 95429, stock: 19, category: "poco" },
      { name: "VAGINSOL F CR VAG X 20GR+3 APLIC. (CLINDAMICINA+CLOTRIMAZOL)", lab: "LABS CHALVER DE COLOMBIA", price: 96622, stock: 13, category: "poco" }
    ];

    /* -------------- Estado -------------- */
    const dom = {
      searchInput: document.getElementById('searchInput'),
      productTableBody: document.getElementById('productTableBody'),
      cardsContainer: document.getElementById('cardsContainer'),
      pagination: document.getElementById('pagination'),
      resultsText: document.getElementById('resultsText'),
      sortInfo: document.getElementById('sortInfo'),
      tableWrap: document.getElementById('tableWrap'),
      noResults: document.getElementById('noResults'),
      statTotal: document.getElementById('statTotal'),
      statAvailable: document.getElementById('statAvailable'),
      statCritical: document.getElementById('statCritical'),
      statOut: document.getElementById('statOut'),
      statValue: document.getElementById('statValue'),
      footerMaxStock: document.getElementById('footerMaxStock'),
      footerHighestPrice: document.getElementById('footerHighestPrice'),
      footerAttention: document.getElementById('footerAttention'),
      currentDateTime: document.getElementById('currentDateTime')
    };

    const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
    const viewButtons = Array.from(document.querySelectorAll('.view-btn'));
    const sortHeaders = Array.from(document.querySelectorAll('thead th[data-sort]'));

    let state = {
      filter: 'todos',
      search: '',
      sort: { column: 'name', direction: 'asc' },
      view: window.innerWidth <= 768 ? 'cards' : 'table',
      page: 1,
      perPage: 8
    };

    // Inicial: activar vista según state.view
    viewButtons.forEach(btn=>{
      btn.classList.toggle('active', btn.getAttribute('data-view')===state.view);
      btn.setAttribute('aria-pressed', btn.getAttribute('data-view')===state.view ? 'true':'false')
    });
    // activar filtro "todos"
    filterButtons.forEach(b=>{
      const pressed = b.getAttribute('data-filter') === state.filter;
      b.setAttribute('aria-pressed', pressed?'true':'false');
    });
    // Mostrar/ocultar wrapper table según vista
    dom.tableWrap.style.display = state.view === 'table' ? 'block' : 'none';
    dom.cardsContainer.style.display = state.view === 'cards' ? 'grid' : 'none';

    /* -------------- Utilidades -------------- */
    function formatPrice(price){
      return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(price);
    }

    function debounce(fn, wait=250){
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
    }

    /* timezone -> Bogota */
    function updateDateTime(){
      const now = new Date();
      const options = { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Bogota' };
      dom.currentDateTime.textContent = now.toLocaleString('es-CO', options).replace(',', '');
    }

    // Setear estadísticas básicas (valores agregados)
    function updateSummary(all){
      const total = all.length;
      const available = all.filter(p => p.category === 'alto').length;
      const critical = all.filter(p => p.category === 'poco').length;
      const out = all.filter(p => p.category === 'agotado').length;
      const totalValue = all.reduce((s,p)=>s + (p.price * p.stock), 0);

      dom.statTotal.textContent = total;
      dom.statAvailable.textContent = available;
      dom.statCritical.textContent = critical;
      dom.statOut.textContent = out;
      dom.statValue.textContent = formatPrice(Math.round(totalValue));

      // footer summaries
      const maxStock = all.slice().sort((a,b)=>b.stock-a.stock)[0];
      const maxPrice = all.slice().sort((a,b)=>b.price-b.price)[0]; // note: this sorts incorrectly; fix below
      const highest = all.slice().reduce((prev,curr)=>curr.price>prev.price?curr:prev, all[0]);
      dom.footerMaxStock.textContent = `Mayor Stock: ${maxStock ? `${maxStock.name} (${maxStock.stock} unidades)` : '—'}`;
      dom.footerHighestPrice.textContent = `Precio Más Alto: ${highest ? `${highest.name} (${formatPrice(highest.price)})` : '—'}`;
      dom.footerAttention.textContent = `Atención: ${critical} productos en estado crítico (stock < 100)`;
    }

    /* -------------- Renderizado -------------- */

    function createTableRows(list){
      dom.productTableBody.innerHTML = '';
      if(list.length === 0){ dom.noResults.style.display = 'block'; return; }
      dom.noResults.style.display = 'none';
      const frag = document.createDocumentFragment();
      list.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <span class="product-name">${escapeHtml(p.name)}</span>
            <span class="lab">${escapeHtml(p.lab)}</span>
          </td>
          <td>${formatPrice(p.price)}</td>
          <td>${p.stock}</td>
          <td><span class="status-badge ${badgeClass(p.category)}">${statusText(p.category)}</span></td>
        `;
        frag.appendChild(tr);
      });
      dom.productTableBody.appendChild(frag);
    }

    function createCards(list){
      dom.cardsContainer.innerHTML = '';
      if(list.length === 0){ dom.noResults.style.display = 'block'; return; }
      dom.noResults.style.display = 'none';
      const frag = document.createDocumentFragment();
      list.forEach(p=>{
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <div class="header">
            <div style="flex:1;min-width:0">
              <div class="title">${escapeHtml(p.name)}</div>
              <div class="meta">${escapeHtml(p.lab)}</div>
            </div>
            <div style="margin-left:8px;text-align:right">
              <div style="font-weight:800">${formatPrice(p.price)}</div>
              <div style="font-size:12px;color:var(--muted);margin-top:6px">${p.stock} unidades</div>
            </div>
          </div>
          <div class="rows" style="margin-top:10px">
            <div class="meta-pill"><span class="status-badge ${badgeClass(p.category)}">${statusText(p.category)}</span></div>
          </div>
        `;
        frag.appendChild(el);
      });
      dom.cardsContainer.appendChild(frag);
    }

    function badgeClass(cat){
      switch(cat){
        case 'alto': return 'badge-alto';
        case 'medio': return 'badge-medio';
        case 'poco': return 'badge-poco';
        default: return 'badge-agotado';
      }
    }

    function statusText(cat){
      if(cat === 'alto') return 'Alto';
      if(cat === 'medio') return 'Medio';
      if(cat === 'poco') return 'Crítico';
      return 'Agotado';
    }

    // escape básico para nombres largos / inyección accidental
    function escapeHtml(s = '') {
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});
    }

    /* -------------- Paginación inteligente (móvil) -------------- */
    function drawPagination(totalItems){
      const totalPages = Math.max(1, Math.ceil(totalItems / state.perPage));
      dom.pagination.innerHTML = '';
      if(totalPages <= 1) return;

      const frag = document.createDocumentFragment();

      const prev = createPageBtn('‹', state.page === 1, ()=>{ if(state.page>1){ state.page--; render(); }});
      frag.appendChild(prev);

      // mostrar máximo 5 números: 1 ... (p-1,p,p+1) ... last
      const windowSize = 1; // pages each side
      const pages = [];

      let start = Math.max(1, state.page - windowSize);
      let end = Math.min(totalPages, state.page + windowSize);

      if(start > 1){ pages.push(1); if(start > 2) pages.push('gap'); }
      for(let i=start;i<=end;i++) pages.push(i);
      if(end < totalPages){ if(end < totalPages-1) pages.push('gap'); pages.push(totalPages); }

      pages.forEach(item=>{
        if(item === 'gap'){
          const el = document.createElement('span'); el.textContent = '…'; el.style.opacity = '0.6'; el.style.padding = '0 6px';
          frag.appendChild(el);
        } else {
          const btn = createPageBtn(String(item), state.page === item, ()=>{ state.page = item; render(); });
          frag.appendChild(btn);
        }
      });

      const next = createPageBtn('›', state.page === totalPages, ()=>{ if(state.page<totalPages){ state.page++; render(); }});
      frag.appendChild(next);
      dom.pagination.appendChild(frag);
    }

    function createPageBtn(text, disabled, onClick){
      const b = document.createElement('button');
      b.className = 'page-btn' + (disabled ? ' disabled' : '');
      b.disabled = !!disabled;
      b.innerHTML = text;
      b.addEventListener('click', onClick);
      if(!disabled) b.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') onClick(); });
      return b;
    }

    /* -------------- Filtrado / Ordenamiento / Render -------------- */
    function getFilteredSorted(){
      const s = state.search.trim().toLowerCase();
      let list = products.filter(p=>{
        const matchesFilter = state.filter === 'todos' || p.category === state.filter;
        const matchesSearch = s === '' || p.name.toLowerCase().includes(s) || p.lab.toLowerCase().includes(s);
        return matchesFilter && matchesSearch;
      });

      // sort
      list.sort((a,b)=>{
        let A,B;
        switch(state.sort.column){
          case 'price': A = a.price; B = b.price; break;
          case 'stock': A = a.stock; B = b.stock; break;
          case 'status':
            const order = {'alto':1,'medio':2,'poco':3,'agotado':4};
            A = order[a.category]; B = order[b.category]; break;
          default:
            A = a.name.toLowerCase(); B = b.name.toLowerCase();
        }
        if(A < B) return state.sort.direction === 'asc' ? -1 : 1;
        if(A > B) return state.sort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      return list;
    }

    function render(){
      // Obtener y actualizar resumen con TODOS los productos
      updateSummary(products);

      const list = getFilteredSorted();
      const totalItems = list.length;
      const totalPages = Math.max(1, Math.ceil(totalItems / state.perPage));

      // Clamp page
      if(state.page > totalPages) state.page = totalPages;
      if(state.page < 1) state.page = 1;

      const start = (state.page - 1) * state.perPage;
      const pageItems = list.slice(start, start + state.perPage);

      // Actual UI
      dom.resultsText.textContent = `Mostrando ${Math.min(pageItems.length, totalItems)} de ${totalItems} productos`;
      dom.sortInfo.textContent = `Orden: ${getSortLabel()}`;

      if(state.view === 'table'){
        dom.tableWrap.style.display = 'block';
        dom.cardsContainer.style.display = 'none';
        createTableRows(pageItems);
      } else {
        dom.tableWrap.style.display = 'none';
        dom.cardsContainer.style.display = 'grid';
        createCards(pageItems);
      }

      drawPagination(totalItems);
    }

    function getSortLabel(){
      const map = { name:'Producto', price:'Precio', stock:'Stock', status:'Estado' };
      return `${map[state.sort.column]} (${state.sort.direction === 'asc' ? 'A-Z' : 'Z-A'})`;
    }

    /* -------------- Event listeners -------------- */

    // Filters
    filterButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        filterButtons.forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        state.filter = b.getAttribute('data-filter');
        state.page = 1;
        render();
      });
    });

    // View toggle
    viewButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> {
        viewButtons.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false')});
        btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
        state.view = btn.getAttribute('data-view');
        render();
      });
    });

    // Search (debounced)
    dom.searchInput.addEventListener('input', debounce((e)=>{
      state.search = e.target.value;
      state.page = 1;
      render();
    }, 250));

    // Sort headers
    sortHeaders.forEach(th=>{
      th.style.cursor = 'pointer';
      th.addEventListener('click', ()=>{
        const col = th.getAttribute('data-sort');
        if(state.sort.column === col){
          state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          state.sort.column = col; state.sort.direction = 'asc';
        }
        // update small visual indicator
        sortHeaders.forEach(h=>h.querySelector('.sort-indicator').innerHTML = '');
        const ind = th.querySelector('.sort-indicator');
        ind.innerHTML = state.sort.direction === 'asc' ? '<i class=\"fas fa-sort-up\"></i>' : '<i class=\"fas fa-sort-down\"></i>';
        render();
      });
    });

    // Keyboard shortcuts: focus search with '/'
    window.addEventListener('keydown', (e)=>{
      if(e.key === '/' && document.activeElement !== dom.searchInput){
        e.preventDefault();
        dom.searchInput.focus();
      }
    });

    // Escape clears search
    dom.searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ dom.searchInput.value = ''; state.search=''; render(); }});

    // Accessibility: update time each minute
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // Inicial render
    render();

    /* ---------- small fixes / notes ---------- */
    // Fix for highest price selection (previous quick sort placeholder)
    // (This executes once to ensure footer shows correct highest price after render)
    (function fixHighestPrice(){
      if(products.length){
        const highest = products.reduce((prev,curr)=>curr.price > prev.price ? curr : prev, products[0]);
        document.getElementById('footerHighestPrice').textContent = `Precio Más Alto: ${highest.name} (${formatPrice(highest.price)})`;
      }
    })();

  </script>
</body>
</html>
